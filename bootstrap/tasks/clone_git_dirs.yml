---
- name: Figure out
  block:
    - name: Get environment
      ansible.builtin.set_fact:
        active_environment: "{{ env_vars }}"
        add_ansible_ssh_common_args: "-o 'IdentityAgent={{ ssh_auth_sock }}"
      when: create_ssh_keypair
    - name: Get git repos
      ansible.builtin.set_fact:
        install_repos: "{{ repo_dictionary[ansible_distribution]}}"
      vars:
        repo_dictionary:
          MacOSX: "{{ git_repos.all }}"
          Ubuntu: "{{ git_repos.all + git_repos.ubuntu }}"
          Debian: "{{ git_repos.all + git_repos.ubuntu }}"

- name: Clone Git directories
  environment: "{{ active_environment }}"
  vars:
    # ansible_user: "{{ setup_user }}"
    ansible_ssh_common_args: "{{ add_ansible_ssh_common_args }}"
  ansible.builtin.git:
    # accept_hostkey: true
    accept_newhostkey: true
    repo: "{{ item.repo }}"
    dest: "{{ item.dest }}"
    depth: 1
    clone: true
  with_items: "{{ git_repos.all + git_repos.ubuntu }}"
  when: create_ssh_keypair and ansible_distribution in ['Ubuntu', 'Debian']
  # become: true
  # become_user: "{{ setup_user }}"

- name: Clone Git directories
  ansible.builtin.git:
    # accept_hostkey: true
    accept_newhostkey: true
    repo: "{{ item.repo }}"
    dest: "{{ item.dest }}"
    depth: 1
    clone: true
  with_items: install_repos
  # become: true
  # become_user: "{{ setup_user }}"

- name: Register ssh-agent env
  ansible.builtin.shell: |
    eval "$(ssh-agent -s)" > /dev/null
    echo '{ "SSH_AUTH_SOCK": "'$SSH_AUTH_SOCK'", "SSH_AGENT_PID": "'$SSH_AGENT_PID'" }'
  register: env_vars_stdout

- name: Set ssh facts
  ansible.builtin.set_fact:
    ssh_env_vars: "{{ env_vars_stdout.stdout }}"
    ssh_auth_sock: "{{ (env_vars_stdout.stdout | from_json | default({ })).SSH_AUTH_SOCK  }}"
    ssh: "{{ ssh_out }}"

- name: Add generated ssh key to ssh-agent
  ansible.builtin.command:
    cmd: "ssh-add {{ ssh_out.filename }}"
  environment: "{{ ssh_env_vars }}"

- name: Upload public key to GitHub
  become: true
  ansible.builtin.uri:
    url: https://api.github.com/user/keys
    method: POST
    follow_redirects: all
    headers:
      Authorization: "Bearer {{ github_token }}"
      Content-Type: application/json
      Accept: application/vnd.github+json
      X-GitHub-Api-Version: 2022-11-28
    body:
      title: "{{ setup_user }}-key"
      key: "{{ key.public_key }}"
    body_format: json
    force_basic_auth: true
    status_code: 201
  when: github_token is defined
